<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>AlexIA - Asistente Virtual</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
    }
    #chat-toggle {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background-color: #0a192f;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 28px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      z-index: 1000;
    }
    #chat-container {
      display: none;
      position: fixed;
      bottom: 100px;
      right: 25px;
      width: 400px;
      height: 600px;
      background-color: #fff;
      border-radius: 20px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      z-index: 999;
    }
    #chat-header {
      background-color: #0a192f;
      color: white;
      padding: 15px;
      font-weight: bold;
      text-align: center;
    }
    #chat-header span {
      display: block;
      font-size: 12px;
      font-weight: normal;
      color: #ccc;
      margin-top: 4px;
    }
    #chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      font-size: 16px;
      line-height: 1.4;
    }
    .message {
      margin-bottom: 12px;
      padding: 12px 18px;
      border-radius: 16px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user {
      background-color: #dcf8c6;
      align-self: flex-end;
    }
    .bot {
      background-color: #f1f0f0;
      align-self: flex-start;
    }
    #listening-indicator {
      display: none;
      text-align: center;
      color: red;
      font-size: 14px;
      padding: 5px;
    }
    #chat-input {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
      gap: 5px;
    }
    #chat-input input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 20px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    #chat-input button {
      background-color: #0a192f;
      color: white;
      border: none;
      padding: 10px 12px;
      border-radius: 20px;
      cursor: pointer;
    }
    #chat-input button:hover {
      background-color: #1e2a3d;
    }
    #chat-input button.clear {
      background-color: #dc3545;
    }
    #chat-input button.clear:hover {
      background-color: #a71d2a;
    }
  </style>
</head>
<body>

<button id="chat-toggle">üí¨</button>

<div id="chat-container">
  <div id="chat-header">
    AlexIA - Asistente Virtual
    <span>Soporte 24/7 impulsado por IA</span>
  </div>
  <div id="chat-messages"></div>
  <div id="listening-indicator">üéôÔ∏è Escuchando...</div>
  <div id="chat-input">
    <input type="text" id="message" placeholder="Escribe o habla..." onkeydown="if(event.key==='Enter') sendMessage()">
    <button id="mic-btn" onclick="startListening()">üé§</button>
    <button onclick="sendMessage()">Enviar</button>
    <button class="clear" onclick="clearChat()">üóëÔ∏è</button>
  </div>
</div>

<script>
  const toggleBtn = document.getElementById('chat-toggle');
  const chatContainer = document.getElementById('chat-container');
  const messagesDiv = document.getElementById('chat-messages');
  const input = document.getElementById('message');
  let historial = [];

  const stored = localStorage.getItem('chatHistorial');
  if (stored) {
    historial = JSON.parse(stored);
    historial.forEach(msg => appendMessage(msg.text, msg.sender, false));
  }

  toggleBtn.onclick = () => {
    chatContainer.style.display = chatContainer.style.display === 'none' ? 'flex' : 'none';
  };

  function appendMessage(text, sender, save = true) {
    const msg = document.createElement('div');
    msg.className = `message ${sender}`;
    msg.textContent = text;
    msg.style.alignSelf = sender === 'user' ? 'flex-end' : 'flex-start';
    messagesDiv.appendChild(msg);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    if (save) {
      historial.push({ sender, text });
      localStorage.setItem('chatHistorial', JSON.stringify(historial));
    }
  }

  async function sendMessage() {
    const message = input.value.trim();
    if (!message) return;

    appendMessage(message, 'user');
    input.value = '';

    const apiUrl = window.location.hostname.includes("localhost")
      ? "http://127.0.0.1:8000/chat"
      : "https://alexia-backend.onrender.com/chat";

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: message })
      });

      const data = await response.json();
      appendMessage(data.response, 'bot');
    } catch (err) {
      appendMessage("‚ùå Error de conexi√≥n", 'bot');
    }
  }

  function startListening() {
    const micBtn = document.getElementById('mic-btn');
    const indicator = document.getElementById('listening-indicator');
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();

    recognition.lang = 'es-ES';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    micBtn.style.backgroundColor = '#dc3545';
    indicator.style.display = 'block';

    recognition.start();

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      input.value = transcript;
      sendMessage();
    };

    recognition.onerror = (event) => {
      alert('Error al reconocer la voz: ' + event.error);
    };

    recognition.onend = () => {
      micBtn.style.backgroundColor = '';
      indicator.style.display = 'none';
    };
  }

  function clearChat() {
    historial = [];
    localStorage.removeItem('chatHistorial');
    messagesDiv.innerHTML = '';
  }
</script>

</body>
</html>
